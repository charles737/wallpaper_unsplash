# 图片下载功能说明

## 功能概述

应用现在支持将 Unsplash 壁纸保存到设备相册，并提供已下载图片的管理功能。

## 主要功能

### 1. 保存图片到相册

在图片详情页面，您可以通过以下方式保存图片：

- **方式一**：点击应用栏的下载按钮（下载图标）
- **方式二**：点击更多按钮（三个点），在弹出菜单中选择"下载图片"

**功能特点**：
- 保存 1440p 高清图片（2560x1440 分辨率）
- 自动保存到系统相册（移动端）或下载到本地（Web 端）
- Android 保存路径：`Pictures/WallpaperUnsplash/`
- Web 保存路径：浏览器默认下载文件夹
- 显示下载进度指示器
- 下载完成后显示成功提示
- 自动记录下载历史
- **支持全平台**：Android、iOS、Web、macOS、Windows、Linux

### 2. 已下载图片管理

点击详情页的"更多"按钮，选择"已下载"即可查看所有下载的图片。

**已下载页面功能**：
- 网格布局展示所有已下载的图片
- 显示图片缩略图、作者名称和下载时间
- 点击图片可以重新查看详情
- 点击图片右上角的 ❌ 按钮可以从列表中删除（图片仍保留在相册中）
- 点击右上角的"清空"按钮可以清空所有下载记录

**时间显示格式**：
- 刚刚：1分钟内
- X 分钟前：1小时内
- X 小时前：24小时内
- X 天前：30天内
- 具体日期：超过30天

### 3. 权限说明

应用需要以下权限才能保存图片：

**Android**：
- 写入外部存储（Android 10 以下）
- 读取外部存储（Android 12 以下）
- 读取媒体图片（Android 13+）

**iOS**：
- 相册添加权限（保存图片时）
- 相册访问权限（查看已下载列表时）

首次使用保存功能时，系统会自动请求相应权限。

## 技术实现

### 使用的包

- `saver_gallery: ^3.0.6` - 保存图片到相册
- `shared_preferences: ^2.3.3` - 存储下载记录
- `permission_handler: ^11.3.1` - 处理权限请求
- `http: ^1.2.0` - 下载图片

### 文件结构

```
lib/
├── pages/
│   ├── photo_detail_page.dart      # 图片详情页（包含下载功能）
│   └── downloaded_photos_page.dart # 已下载页面（新增）
├── services/
│   ├── download_helper_web.dart    # Web 平台下载实现（新增）
│   └── download_helper_stub.dart   # 其他平台占位符（新增）
└── models/
    └── unsplash_photo.dart         # 图片数据模型
```

### 平台适配

应用使用**条件导入**实现跨平台支持：

- **Web 平台**：使用 `dart:html` 触发浏览器下载
  - 创建 Blob 对象
  - 生成下载链接
  - 自动触发下载到浏览器默认文件夹
  
- **移动/桌面平台**：使用 `saver_gallery` 保存到相册
  - Android/iOS：保存到系统相册
  - macOS/Windows/Linux：保存到图片文件夹

### 数据存储

下载记录使用 `shared_preferences` 存储在本地，包含以下信息：
- 图片完整信息（ID、URL、作者等）
- 下载时间
- 保存路径（可选）

存储格式：JSON 字符串列表

## 注意事项

1. **下载质量**：默认下载 1440p 高清图片，大小约 2-5MB
2. **存储空间**：请确保设备有足够的存储空间
3. **网络流量**：下载高清图片会消耗较多流量，建议在 WiFi 环境下使用
4. **删除说明**：从"已下载"列表中删除只会移除记录，不会删除相册中的图片
5. **重复下载**：同一张图片可以多次下载，每次会生成新的文件
6. **Web 平台**：
   - 文件会下载到浏览器默认下载文件夹
   - 下载路径由浏览器设置决定
   - 部分浏览器可能会弹出下载确认对话框

## 界面说明

### 图片详情页 AppBar 按钮（从左到右）：

1. **返回按钮**：返回上一页
2. **下载按钮**：保存图片（下载中会显示进度动画）
3. **分享按钮**：分享图片链接
4. **更多按钮**：显示更多选项菜单

### 更多选项菜单：

- **下载图片**：保存当前图片到相册
- **已下载**：查看所有下载的图片
- **取消**：关闭菜单

## 错误处理

应用会处理以下情况并显示相应提示：

- ❌ 网络错误：下载失败
- ❌ 权限被拒绝：无法保存
- ❌ 存储空间不足：保存失败
- ❌ 重复下载：防止并发下载
- ✅ 成功保存：显示"图片已保存到相册"

## 未来改进

可能的功能增强：
- [ ] 支持选择下载质量（原图/高清/标准）
- [ ] 批量下载功能
- [ ] 设置为壁纸功能
- [ ] 下载进度百分比显示
- [ ] 从相册中直接删除图片
- [ ] 收藏功能

